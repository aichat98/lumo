<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ëŠ˜ì˜ ë°¥ ìƒì„±ê¸°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f0f0; min-height: 100vh; }
        
        .container { display: flex; min-height: 100vh; }
        
        .controls { 
            flex: 1;
            background: white; 
            padding: 25px; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .result-wrapper { 
            flex: 3; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 50px; 
            position: relative; 
            gap: 10px; 
        }
        
        .pair-name { position: absolute; top: 20px; right: 220px; z-index: 5; font-size: 14px; font-weight: 500; opacity: 0.7; }
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 15px; }
        textarea.input-field { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-height: 200px; resize: vertical; overflow-y: auto; }
        .button-group { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .btn-primary { background: #007aff; color: white; } .btn-danger { background: #dc3545; color: white; }
        
        .lunch-tray-area { position: relative; width: 600px; height: 400px; background: url('https://i.imgur.com/j1ePEU9.png') center/contain no-repeat; }
        .food-placeholder { position: absolute; display: flex; align-items: center; justify-content: center; font-size: 50px; }
        .speech-bubble { position: absolute; background: white; border: 2px solid #ddd; padding: 10px 14px; font-size: 12px; font-weight: 500; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10; max-width: 240px; text-align: center; }
        .speech-bubble.left { top: 18px; left: -2px; border-radius: 15px 15px 15px 5px; }
        .speech-bubble.right { bottom: 38px; right: -8px; border-radius: 15px 15px 5px 15px; }
        #food-1 { top: 16%; left: 21%; width: 80px; height: 80px; } 
        #food-2 { top: 16%; left: 36%; width: 80px; height: 80px; }
        #food-3 { top: 16%; left: 51%; width: 80px; height: 80px; } 
        #food-4 { top: 16%; left: 67%; width: 80px; height: 80px; }
        #food-5 { top: 40%; left: 25%; width: 150px; height: 150px; font-size: 108px; } 
        #food-6 { top: 40%; left: 56%; width: 150px; height: 150px; font-size: 108px; }
        
        .review-card-area { width: 550px; background: #ffffff; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); overflow: hidden; position: relative; }
        .info-header { background-color: #f1f3f5; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .info-header .date { font-size: 16px; font-weight: 600; color: #333; }
        .info-header .calories { font-size: 14px; font-weight: 500; color: #e54d42; background-color: #fef4f4; padding: 4px 10px; border-radius: 20px; }
        .content-area { padding: 20px; }
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .grid-item { background-color: #f8f9fa; border-radius: 8px; padding: 12px; text-align: center; }
        .grid-item .icon { font-size: 24px; color: #007aff; margin-bottom: 5px; }
        .grid-item .menu-name { font-size: 13px; font-weight: 600; color: #333; }
        .grid-item .category { font-size: 11px; color: #888; }
        .review-box { display: flex; align-items: center; gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; position: relative; overflow: visible; }
        .review-box .stars { font-size: 24px; color: #ffd700; }
        .review-box .stars .empty { color: #dcdcdc; }
        .review-box .review-text { font-size: 13px; line-height: 1.6; flex: 1; color: #444; padding-right: 70px; }
        .meokjjang-stamp { position: absolute; top: 40%; right: 10px; transform: translateY(-50%) rotate(15deg) scale(0.8); width: 50px; height: 50px; opacity: 0; transition: all 0.3s ease; border: 2px solid #ff6b6b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; color: #ff6b6b; background: white; z-index: 10; }
        .meokjjang-stamp::before { content: "ë¨¹ì§±"; }
        .meokjjang-stamp.show { opacity: 0.85; transform: translateY(-50%) rotate(-10deg) scale(1); }
        
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1000; justify-content: center; align-items: center; }
        .popup { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 500px; width: 90%; }
        .popup h3 { margin-bottom: 15px; } .popup textarea { width: 100%; height: 250px; font-family: monospace; font-size: 12px; border: 1px solid #ddd; border-radius: 5px; padding: 10px; }
        .popup-buttons { margin-top: 15px; text-align: right; } .popup-buttons button { margin-left: 10px; }
        
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .controls { padding: 15px; }
            .result-wrapper { padding: 20px; overflow-x: auto; }
            textarea.input-field { min-height: 150px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <h2>ì˜¤ëŠ˜ì˜ ë°¥ ìƒì„±ê¸°</h2>
            <div class="control-group">
                <label>ëª…ë ¹ì–´ ë¶™ì—¬ë„£ê¸° <i class="fa-solid fa-pen-to-square" onclick="openCommandHelp()" style="cursor: pointer;"></i></label>
                <textarea class="input-field" id="commandInput" placeholder="ì´ê³³ì— AIê°€ ìƒì„±í•œ ëª…ë ¹ì–´ë¥¼ ë¶™ì—¬ë„£ìœ¼ë©´ ëª¨ë“  ë‚´ìš©ì´ í•œ ë²ˆì— ì ìš©ë©ë‹ˆë‹¤." oninput="autoResize(this); parseAndRenderAll()"></textarea>
            </div>
            <div class="button-group">
                <button class="btn btn-danger" onclick="clearAll()">ì´ˆê¸°í™”</button>
                <button class="btn btn-primary" onclick="takeScreenshot()">ìŠ¤í¬ë¦°ìƒ·</button>
            </div>
        </div>

        <div class="result-wrapper" id="resultWrapper">
            <div class="pair-name" id="pairName"></div>
            <div class="lunch-tray-area">
                <div class="speech-bubble left" id="leftSpeech">ì˜ë¨¹ê² ìŠµë‹ˆë‹¤!</div>
                <div class="speech-bubble right" id="rightSpeech">ë§›ìˆê² ë‹¤~</div>
                <div class="food-placeholder" id="food-1"></div>
                <div class="food-placeholder" id="food-2"></div>
                <div class="food-placeholder" id="food-3"></div>
                <div class="food-placeholder" id="food-4"></div>
                <div class="food-placeholder" id="food-5"></div>
                <div class="food-placeholder" id="food-6"></div>
            </div>
            <div class="review-card-area">
                <div class="info-header">
                    <span class="date" id="reviewDate"></span>
                    <span class="calories" id="reviewCalories"></span>
                </div>
                <div class="content-area">
                    <div class="menu-grid" id="menuGrid"></div>
                    <div class="review-box">
                        <div class="stars" id="reviewStars"></div>
                        <div class="review-text" id="reviewText"></div>
                        <div class="meokjjang-stamp" id="meokjjangStamp1"></div>
                    </div>
                    <div class="review-box">
                        <div class="stars" id="reviewStars2"></div>
                        <div class="review-text" id="reviewText2"></div>
                        <div class="meokjjang-stamp" id="meokjjangStamp2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="popup-overlay" id="popupOverlay">
        <div class="popup">
            <h3>ëª…ë ¹ì–´ ê°€ì´ë“œ</h3>
            <textarea readonly>[oocëª¨ë“œ - ë¡¤í”Œ ì ì‹œ ì¤‘ì§€]
ìºë¦­í„°ë“¤ ì„¤ì •ì— ë§ê²Œ ì˜¤ëŠ˜ ë¨¹ì€ ë°¥ ë©”ë‰´ë¥¼ ì–‘ì‹ì— ë§ê²Œ ì¶œë ¥í•œë‹¤.
                
[{ìºë¦­í„° í—¥ìŠ¤ì½”ë“œ}][{ìœ ì € í—¥ìŠ¤ì½”ë“œ}]
[{í˜ì–´ëª…}]
[{YYYY-MM-DD ìš”ì¼}]
[ì´ëª¨ì§€: {ë””ì €íŠ¸}, {ë¶€ìš”ë¦¬}, {ì£¼ìš”ë¦¬}, {ìŒë£Œ}, {ì£¼ì‹}, {êµ­ë¬¼}]
[ë©”ë‰´ëª…:{ë””ì €íŠ¸}, {ë¶€ìš”ë¦¬}, {ì£¼ìš”ë¦¬}, {ìŒë£Œ}, {ì£¼ì‹}, {êµ­ë¬¼}]
[{ì¹¼ë¡œë¦¬}]

[{ìºë¦­í„° ì‹ì „ì¸ì‚¬}] [{ìœ ì € ì‹ì „ì¸ì‚¬}]
[ìºë¦­í„° ë³„ì :{1-5}] [{í›„ê¸°}]
[ìœ ì € ë³„ì :{1-5}] [{í›„ê¸°}]</textarea>
            <div class="popup-buttons">
                <button class="btn btn-danger" onclick="closeCommandHelp()">ë‹«ê¸°</button>
                <button class="btn btn-primary" onclick="copyCommandTemplate()">ë³µì‚¬</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.max(200, textarea.scrollHeight) + 'px';
        }
        
function parseAndRenderAll() {
    const command = document.getElementById('commandInput').value;
    
    const allBrackets = command.match(/\[([^\]]+)\]/g);
    if (!allBrackets) return;
    
    const items = allBrackets.map(item => item.slice(1, -1));
    
    const charColor = items[0] || '';
    const userColor = items[1] || '';
    const pairName = items[2] || '';
    const dateVal = items[3] || '';
    const emojiStr = (items[4] || '').replace('ì´ëª¨ì§€:', '').trim();
    const menuStr = (items[5] || '').replace('ë©”ë‰´ëª…:', '').trim();
    const caloriesStr = (items[6] || '').replace(/Kcal|kcal|ì¹¼ë¡œë¦¬/gi, '').trim();
    const leftSpeech = items[7] || 'ì˜ë¨¹ê² ìŠµë‹ˆë‹¤!';
    const rightSpeech = items[8] || 'ë§›ìˆê² ë‹¤~';
    
    let charRating = 0;
    let charReview = '';
    let userRating = 0;
    let userReview = '';
    
    for (let i = 9; i < items.length; i++) {
        if (items[i].includes('ë³„ì :')) {
            let rating = 0;
            
            const numberMatch = items[i].match(/ë³„ì :\s*(\d+(\.\d+)?)/); // ìˆ«ì(1-5) ë° ì†Œìˆ˜ì ë„ ì¸ì‹í•˜ë„ë¡ ê°œì„ 
            if (numberMatch) {
                rating = parseFloat(numberMatch[1]);
            } 
            else {
                const starMatch = items[i].match(/ë³„ì :\s*(â˜…*â˜†*)/);
                if (starMatch) {
                    const stars = starMatch[1];
                    // --- ì—¬ê¸°ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤! ---
                    // ê½‰ ì°¬ ë³„(â˜…)ì˜ ê°œìˆ˜ë§Œ ì„¸ì–´ì„œ ì ìˆ˜ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                    // ë¹ˆ ë³„(â˜†)ì€ ì ìˆ˜ ê³„ì‚°ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    const fullStars = (stars.match(/â˜…/g) || []).length;
                    rating = fullStars; 
                    // --- ìˆ˜ì • ë ---
                }
            }
            
            const review = (items[i + 1] || '').replace(/^í›„ê¸°:\s*/, '');
            
            if (charRating === 0 && charReview === '') { // ì¢€ ë” ëª…í™•í•œ ì¡°ê±´ìœ¼ë¡œ ë³€ê²½
                charRating = rating;
                charReview = review;
            } else {
                userRating = rating;
                userReview = review;
                break; 
            }
            i++; // í›„ê¸° ê±´ë„ˆë›°ê¸°
        }
    }
    
    // ë°°ê²½ìƒ‰ ì ìš©
    if (charColor && charColor.includes('#')) {
        document.getElementById('resultWrapper').style.backgroundColor = charColor;
        
        const r = parseInt(charColor.slice(1, 3), 16);
        const g = parseInt(charColor.slice(3, 5), 16);
        const b = parseInt(charColor.slice(5, 7), 16);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        document.getElementById('pairName').style.color = brightness > 128 ? '#333' : '#fff';
    } else {
        document.getElementById('resultWrapper').style.backgroundColor = '#f0f0f0';
        document.getElementById('pairName').style.color = '#333';
    }
    
    document.getElementById('pairName').textContent = pairName;
    
    // ë‚ ì§œ í¬ë§·
    let formattedDate = '----. --. --.';
    if (dateVal) {
        const parts = dateVal.split(' ');
        if (parts.length >= 2) {
            const datePart = parts[0];
            const dayPart = parts[1];
            const dateComponents = datePart.split('-');
            if (dateComponents.length === 3) {
                const year = dateComponents[0];
                const month = dateComponents[1] === 'XX' ? 'XX' : parseInt(dateComponents[1], 10);
                const day = dateComponents[2] === 'XX' ? 'XX' : parseInt(dateComponents[2], 10);
                formattedDate = `${year}. ${month}. ${day}. ${dayPart}`;
            }
        }
    }
    document.getElementById('reviewDate').textContent = formattedDate;
    document.getElementById('reviewCalories').textContent = caloriesStr ? caloriesStr + ' Kcal' : '';
    
    // ì´ëª¨ì§€
    const emojis = emojiStr.split(',').map(e => e.trim()).filter(e => e);
    for (let i = 1; i <= 6; i++) {
        const foodEl = document.getElementById(`food-${i}`);
        if(foodEl) foodEl.textContent = emojis[i-1] || '';
    }
    
    // ë©”ë‰´ ê·¸ë¦¬ë“œ
    const menuGrid = document.getElementById('menuGrid');
    menuGrid.innerHTML = '';
    
    if (menuStr) {
        const categories = ['ë””ì €íŠ¸', 'ë¶€ìš”ë¦¬', 'ì£¼ìš”ë¦¬', 'ìŒë£Œ', 'ì£¼ì‹', 'êµ­ë¬¼'];
        const menuItems = menuStr.split(',').map(item => item.trim()).filter(item => item);
        
        categories.forEach((category, index) => {
            if (menuItems[index]) {
                const menuName = menuItems[index].trim();
                const icon = emojis[index] || 'ğŸ—’ï¸';
                
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                gridItem.innerHTML = `
                    <div class="icon">${icon}</div>
                    <div class="menu-name">${menuName}</div>
                    <div class="category">${category}</div>
                `;
                menuGrid.appendChild(gridItem);
            }
        });
    }
    
    // ìœ ì € ìƒ‰ìƒ ì ìš©
    if (userColor && userColor.includes('#')) {
        const r = parseInt(userColor.slice(1, 3), 16);
        const g = parseInt(userColor.slice(3, 5), 16);
        const b = parseInt(userColor.slice(5, 7), 16);
        
        const headerR = Math.round(241 * 0.8 + r * 0.2);
        const headerG = Math.round(243 * 0.8 + g * 0.2);
        const headerB = Math.round(245 * 0.8 + b * 0.2);
        document.querySelector('.info-header').style.backgroundColor = `rgb(${headerR}, ${headerG}, ${headerB})`;
        
        const gridR = Math.round(248 * 0.85 + r * 0.15);
        const gridG = Math.round(249 * 0.85 + g * 0.15);
        const gridB = Math.round(250 * 0.85 + b * 0.15);
        document.querySelectorAll('.grid-item').forEach(item => {
            item.style.backgroundColor = `rgb(${gridR}, ${gridG}, ${gridB})`;
        });
        
        const reviewR = Math.round(248 * 0.95 + r * 0.05);
        const reviewG = Math.round(249 * 0.95 + g * 0.05);
        const reviewB = Math.round(250 * 0.95 + b * 0.05);
        document.querySelectorAll('.review-box').forEach(box => {
            box.style.backgroundColor = `rgb(${reviewR}, ${reviewG}, ${reviewB})`;
        });
    }
    
    document.getElementById('leftSpeech').textContent = leftSpeech;
    document.getElementById('rightSpeech').textContent = rightSpeech;
    
    function renderStars(elementId, rating) {
        const starsEl = document.getElementById(elementId);
        starsEl.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
            if (rating >= i) starsEl.innerHTML += '<i class="fa-solid fa-star"></i>';
            else if (rating >= i - 0.5) starsEl.innerHTML += '<i class="fa-solid fa-star-half-stroke"></i>';
            else starsEl.innerHTML += '<i class="fa-regular fa-star empty"></i>';
        }
    }
    
    renderStars('reviewStars', charRating);
    renderStars('reviewStars2', userRating);
    
    document.getElementById('reviewText').textContent = charReview;
    document.getElementById('reviewText2').textContent = userReview;
    
    document.getElementById('meokjjangStamp1').classList.toggle('show', charRating === 5);
    document.getElementById('meokjjangStamp2').classList.toggle('show', userRating === 5);
}

        function clearAll() {
            document.getElementById('commandInput').value = '';
            parseAndRenderAll();
        }
        
async function takeScreenshot() {
    window.scrollTo(0, 0);
    const originalElement = document.getElementById('resultWrapper');

    const clone = originalElement.cloneNode(true);
    clone.style.position = 'absolute';
    clone.style.left = '-9999px';
    clone.style.top = '0px';
    clone.style.width = originalElement.offsetWidth + 'px';
    clone.style.height = 'auto';
    document.body.appendChild(clone);

    await new Promise(resolve => setTimeout(resolve, 300));

    try {
        const canvas = await html2canvas(clone, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: window.getComputedStyle(clone).backgroundColor,
        });

        // --- ì—¬ê¸°ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤ ---
        // ì˜ë¼ë‚¼ í¬ê¸°ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
        const scale = 2;
        const cropTop = 5 * scale;
        const cropBottom = 5 * scale;
        // ê¸°ì¡´ 100pxì—ì„œ 50pxì”© ë” ìë¥´ë„ë¡ 150ìœ¼ë¡œ ë³€ê²½
        const cropLeft = 150 * scale; 
        const cropRight = 150 * scale;
        // --- ìˆ˜ì • ë ---

        const croppedWidth = canvas.width - cropLeft - cropRight;
        const croppedHeight = canvas.height - cropTop - cropBottom;

        const croppedCanvas = document.createElement('canvas');
        croppedCanvas.width = croppedWidth;
        croppedCanvas.height = croppedHeight;
        const ctx = croppedCanvas.getContext('2d');

        ctx.drawImage(
            canvas,
            cropLeft,
            cropTop,
            croppedWidth,
            croppedHeight,
            0,
            0,
            croppedWidth,
            croppedHeight
        );

        const link = document.createElement('a');
        link.download = 'ì˜¤ëŠ˜ì˜ë°¥_' + new Date().toISOString().slice(0, 10) + '.png';
        link.href = croppedCanvas.toDataURL('image/png');
        link.click();

    } finally {
        document.body.removeChild(clone);
    }
}
        function openCommandHelp() { document.getElementById('popupOverlay').style.display = 'flex'; }
        function closeCommandHelp() { document.getElementById('popupOverlay').style.display = 'none'; }
        function copyCommandTemplate() {
            const template = document.querySelector('.popup textarea').value;
            navigator.clipboard.writeText(template).then(() => alert('ëª…ë ¹ì–´ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'), () => alert('ë³µì‚¬ ì‹¤íŒ¨'));
        }

        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('popupOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeCommandHelp(); });
            clearAll();
        });
    </script>
</body>
</html>
