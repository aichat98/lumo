<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>페어틀 제작기</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #333;
            --light-color: rgba(51, 51, 51, 0.1);
            --speech-color: rgba(51, 51, 51, 0.2);
            --emoji-border-color: #ccc;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 15px;
            min-width: 1240px;
            overflow-x: auto;
        }

        .fairtle-card {
            background: white;
            border: 1px solid #e1e8ed;
            width: 1200px;
            margin: 0 auto;
            padding: 30px;
            display: grid;
            grid-template-columns: 280px 2fr 280px;
            grid-template-rows: auto auto 1fr;
            gap: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 15px;
            position: relative;
        }

        /* Header */
        .pair-header {
            grid-column: 1 / -1;
            text-align: center;
            border-bottom: 2px solid var(--primary-color, #333);
            padding-bottom: 15px;
        }

        .pair-title {
            font-size: 2.2em;
            font-weight: 700;
            color: #333;
            letter-spacing: 2px;
        }

        .pair-subtitle {
            font-size: 1em;
            color: #666;
            margin-top: 6px;
        }

        /* Character Profile */
        .character-profile {
            text-align: center;
            border: 1px solid #eee;
            background: white;
        }

        .character-avatar {
            width: 100%;
            height: 220px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 0.8em;
            margin-bottom: 15px;
            position: relative;
            background-size: cover;
            background-position: center;
        }

        .character-avatar.has-image::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0) 50%, 
                rgba(255,255,255,0.3) 70%, 
                rgba(255,255,255,1) 100%
            );
            pointer-events: none;
            z-index: 1;
        }

        .color-chart {
            position: absolute;
            top: 10px;
            left: 10px;
            display: grid;
            gap: 3px;
            z-index: 10;
        }

        .color-square {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
        }

        .emoji-circle {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--emoji-border-color, #ccc);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
        }

        .profile-content {
            padding: 0 15px 15px 15px;
        }

        .profile-info {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .character-name {
            font-size: 1.6em;
            font-weight: 600;
            color: #333;
            text-align: right;
            flex: 1;
        }

        .character-basic {
            font-size: 0.65em;
            color: #666;
            line-height: 1.3;
            text-align: left;
            flex: 1;
            margin-left: 8px;
        }

        .character-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: center;
            margin-top: 8px;
        }

        .keyword-tag {
            background: var(--light-color, #f0f0f0);
            color: #555;
            padding: 3px 8px;
            font-size: 0.65em;
            border: 1px solid #ddd;
        }

        .character-speech {
            margin-top: 15px;
            padding: 12px 15px;
            background: var(--speech-color, #e0e0e0);
            border-radius: 15px;
            position: relative;
            font-size: 0.8em;
            color: #333;
            line-height: 1.3;
        }

        .character-speech::after {
            content: '';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }

        .character-speech.left::after {
            left: -7px;
            border-right: 7px solid var(--speech-color, #e0e0e0);
        }

        .character-speech.right::after {
            right: -7px;
            border-left: 7px solid var(--speech-color, #e0e0e0);
        }

        /* Character Details */
        .character-details {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .detail-section {
            border: 1px solid #eee;
            background: white;
        }

        .detail-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #333;
            padding: 10px 12px;
            background: var(--light-color, #f8f8f8);
            border-bottom: 1px solid #eee;
        }

        .detail-content {
            font-size: 0.8em;
            color: #555;
            line-height: 1.6;
            padding: 12px;
            min-height: 100px;
            white-space: pre-wrap;
        }

        /* Timeline */
        .timeline-section {
            border: 1px solid #ddd;
            background: white;
            padding: 20px;
        }

        .timeline-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        .timeline-container {
            position: relative;
            padding: 20px 0;
        }

        .timeline-line {
            position: absolute;
            left: 30px;
            top: 0;
            width: 2px;
            background: var(--primary-color, #333);
            height: 85%;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 40px;
            padding-left: 60px;
        }

        .timeline-dot {
            position: absolute;
            left: 25px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-color, #333);
            border: 3px solid white;
        }

        .timeline-dot::after {
            content: '';
            position: absolute;
            top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: 50%;
            border: 2px solid var(--primary-color, #333);
        }

        .timeline-date {
            font-size: 0.9em;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
            padding: 3px 8px;
            background: var(--primary-color, #333);
            display: inline-block;
            border-radius: 3px;
        }

        .timeline-title-text {
            font-size: 0.95em;
            font-weight: 500;
            color: #555;
            margin-bottom: 6px;
        }

        .timeline-desc {
            font-size: 0.8em;
            color: #666;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .timeline-image {
            width: 100%;
            height: auto;
            border-radius: 5px;
            margin-top: 8px;
            border: 1px solid #ddd;
            display: block;
        }

        /* Stickers */
        .fairtle-sticker {
            position: absolute;
            cursor: move;
            z-index: 100;
            border: 2px solid transparent;
            user-select: none;
            pointer-events: auto;
        }

        .fairtle-sticker img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            pointer-events: none;
        }

        .fairtle-sticker:hover,
        .fairtle-sticker.selected {
            border-color: #007bff;
        }

        .sticker-controls {
            position: absolute;
            top: -8px;
            right: -8px;
            display: none;
            flex-direction: column;
            gap: 4px;
        }

        .fairtle-sticker.selected .sticker-controls {
            display: flex;
        }

        .sticker-delete {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 101;
        }

        .sticker-rotate {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 101;
        }

        .sticker-rotate:active {
            cursor: grabbing;
        }

        .resize-handle {
            position: absolute;
            bottom: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            background: #007bff;
            border: 2px solid white;
            border-radius: 50%;
            cursor: se-resize;
            display: none;
            z-index: 101;
        }

        .fairtle-sticker.selected .resize-handle {
            display: block;
        }

        /* UI Controls */
        .edit-button, .download-button {
            position: fixed;
            bottom: 30px;
            background: #333;
            color: white;
            border: none;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .edit-button {
            right: 30px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 20px;
        }

        .download-button {
            left: 30px;
            padding: 12px 20px;
        }

        /* Edit Panel */
        .edit-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60vh;
            background: white;
            border-top: 2px solid #333;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 999;
            overflow-y: auto;
        }

        .edit-panel.active {
            transform: translateY(0);
        }

        .edit-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .edit-panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
        }

        .edit-content {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            font-size: 14px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            line-height: 1.6;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .sticker-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            min-height: 60px;
            border: 1px dashed #ddd;
            padding: 10px;
            background: #fafafa;
        }

        .sticker-preview {
            position: relative;
            width: 50px;
            height: 50px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
            background: white;
        }

        .sticker-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sticker-preview:hover {
            border-color: #007bff;
        }

        .timeline-form-item {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .color-input-group {
            display: flex;
            gap: 8px;
        }

        .color-input-item {
            flex: 1;
            min-width: 50px;
        }

        .color-input-item input {
            width: 100%;
            height: 40px;
            padding: 0;
            border-radius: 4px;
        }

        .color-input-label {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 2px;
        }

        .basic-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .basic-info-grid input {
            padding: 8px;
        }

        .btn-add {
            width: 100%;
            padding: 10px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            margin-top: 10px;
            cursor: pointer;
        }

        .btn-delete {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            font-size: 12px;
            margin-top: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="fairtle-card" id="fairtle-card">
        <div class="pair-header">
            <div class="pair-title" id="pair-title">SAMPLE PAIR</div>
            <div class="pair-subtitle" id="pair-subtitle">캐릭터 A × 캐릭터 B</div>
        </div>
        
        <!-- 캐릭터 A -->
        <div class="character-section">
            <div class="character-profile">
                <div class="character-avatar" id="char1-avatar">
                    <div class="color-chart">
                        <div class="color-square" id="char1-hair-color" style="background: #8B4513;"></div>
                        <div class="color-square" id="char1-eyes-color" style="background: #4169E1;"></div>
                        <div class="color-square" id="char1-skin-color" style="background: #FDBCB4;"></div>
                    </div>
                    <div class="emoji-circle" id="char1-emoji">🐱</div>
                    프로필 이미지
                </div>
                <div class="profile-content">
                    <div class="profile-info">
                        <div class="character-name" id="char1-name">캐릭터 A</div>
                        <div class="character-basic" id="char1-basic">
                            <div>남성 | 20세 | 175cm</div>
                            <div>학생</div>
                        </div>
                    </div>
                    <div class="character-keywords" id="char1-keywords">
                        <span class="keyword-tag">성격1</span>
                        <span class="keyword-tag">성격2</span>
                        <span class="keyword-tag">성격3</span>
                    </div>
                    <div class="character-speech left" id="char1-speech">캐릭터 A가 캐릭터 B에게 하는 말</div>
                </div>
            </div>
            
            <div class="character-details">
                <div class="detail-section">
                    <div class="detail-title">Backstory</div>
                    <div class="detail-content" id="char1-past">캐릭터의 과거 이야기가 들어갑니다.</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Etc.</div>
                    <div class="detail-content" id="char1-features">캐릭터의 독특한 특징이나 습관, 버릇을 설명해주세요.</div>
                </div>
                
                <div class="character-extra-sections" id="char1-extra-sections"></div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="timeline-section">
            <div class="timeline-title">Timeline</div>
            <div class="timeline-container" id="timeline-container">
                <div class="timeline-line"></div>
            </div>
        </div>

        <!-- 캐릭터 B -->
        <div class="character-section">
            <div class="character-profile">
                <div class="character-avatar" id="char2-avatar">
                    <div class="emoji-circle" id="char2-emoji" style="left: 10px; right: auto;">🐰</div>
                    <div class="color-chart" style="left: auto; right: 10px;">
                        <div class="color-square" id="char2-hair-color" style="background: #8B4513;"></div>
                        <div class="color-square" id="char2-eyes-color" style="background: #4169E1;"></div>
                        <div class="color-square" id="char2-skin-color" style="background: #FDBCB4;"></div>
                    </div>
                    프로필 이미지
                </div>
                <div class="profile-content">
                    <div class="profile-info">
                        <div class="character-name" id="char2-name">캐릭터 B</div>
                        <div class="character-basic" id="char2-basic">
                            <div>여성 | 22세 | 180cm</div>
                            <div>직장인</div>
                        </div>
                    </div>
                    <div class="character-keywords" id="char2-keywords">
                        <span class="keyword-tag">성격1</span>
                        <span class="keyword-tag">성격2</span>
                        <span class="keyword-tag">성격3</span>
                    </div>
                    <div class="character-speech right" id="char2-speech">캐릭터 B가 캐릭터 A에게 하는 말</div>
                </div>
            </div>
            
            <div class="character-details">
                <div class="detail-section">
                    <div class="detail-title">Backstory</div>
                    <div class="detail-content" id="char2-past">캐릭터 B의 과거 이야기가 들어갑니다.</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">Etc.</div>
                    <div class="detail-content" id="char2-features">캐릭터 B의 독특한 특징이나 습관, 버릇을 설명해주세요.</div>
                </div>
                
                <div class="character-extra-sections" id="char2-extra-sections"></div>
            </div>
        </div>
    </div>

    <button class="edit-button" onclick="app.toggleEdit()">✏️</button>
    <button class="download-button" onclick="app.downloadImage()">📥 저장</button>

    <div class="edit-panel" id="edit-panel">
        <div class="edit-panel-header">
            <div class="edit-panel-title">페어틀 편집</div>
            <button class="close-button" onclick="app.closeEdit()">×</button>
        </div>
        <div class="edit-content">
            <!-- 페어명 -->
            <div class="form-group">
                <label class="form-label">페어명</label>
                <input type="text" class="form-input" id="input-pair-title" value="SAMPLE PAIR">
            </div>

            <!-- 페어 부제목 -->
            <div class="form-group">
                <label class="form-label">페어 부제목</label>
                <input type="text" class="form-input" id="input-pair-subtitle" value="캐릭터 A × 캐릭터 B">
            </div>

            <!-- 페어 대표컬러 -->
            <div class="form-group">
                <label class="form-label">페어 대표컬러</label>
                <input type="color" class="form-input" id="input-pair-color" value="#333333" style="height: 50px; padding: 5px; cursor: pointer;">
            </div>

            <!-- 스티커 추가 -->
            <div class="form-group">
                <label class="form-label">스티커 추가</label>
                <input type="file" class="form-input" id="input-sticker-upload" accept="image/*" multiple>
                <div id="sticker-preview-container" class="sticker-preview-container">
                    <div style="width: 100%; text-align: center; color: #999; font-size: 12px;">스티커를 업로드하면 여기에 표시되고, 클릭해서 페어틀에 추가할 수 있습니다</div>
                </div>
            </div>

            <!-- A/B 프로필 이미지 -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">A 프로필 이미지</label>
                    <input type="file" class="form-input" id="input-char1-image" accept="image/*">
                </div>
                <div class="form-group">
                    <label class="form-label">B 프로필 이미지</label>
                    <input type="file" class="form-input" id="input-char2-image" accept="image/*">
                </div>
            </div>

            <!-- A/B 이름 -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">A 이름</label>
                    <input type="text" class="form-input" id="input-char1-name" value="캐릭터 A">
                </div>
                <div class="form-group">
                    <label class="form-label">B 이름</label>
                    <input type="text" class="form-input" id="input-char2-name" value="캐릭터 B">
                </div>
            </div>

            <!-- A/B 기본정보 -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">A 기본정보</label>
                    <div class="basic-info-grid">
                        <input type="text" class="form-input" id="input-char1-gender" placeholder="성별" value="남성">
                        <input type="text" class="form-input" id="input-char1-age" placeholder="나이" value="20">
                        <input type="text" class="form-input" id="input-char1-height" placeholder="키" value="175cm">
                        <input type="text" class="form-input" id="input-char1-job" placeholder="직업" value="학생">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">B 기본정보</label>
                    <div class="basic-info-grid">
                        <input type="text" class="form-input" id="input-char2-gender" placeholder="성별" value="여성">
                        <input type="text" class="form-input" id="input-char2-age" placeholder="나이" value="22">
                        <input type="text" class="form-input" id="input-char2-height" placeholder="키" value="180cm">
                        <input type="text" class="form-input" id="input-char2-job" placeholder="직업" value="직장인">
                    </div>
                </div>
            </div>

            <!-- A/B 성격 키워드 -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">A 성격 키워드</label>
                    <input type="text" class="form-input" id="input-char1-keywords" placeholder="성격1, 성격2, 성격3" value="성격1, 성격2, 성격3">
                </div>
                <div class="form-group">
                    <label class="form-label">B 성격 키워드</label>
                    <input type="text" class="form-input" id="input-char2-keywords" placeholder="성격1, 성격2, 성격3" value="성격1, 성격2, 성격3">
                </div>
            </div>

            <!-- A/B 컬러차트 -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">A 컬러차트</label>
                    <div class="color-input-group">
                        <div class="color-input-item">
                            <input type="color" class="form-input" id="input-char1-hair" value="#8B4513">
                            <div class="color-input-label">머리</div>
                        </div>
                        <div class="color-input-item">
                            <input type="color" class="form-input" id="input-char1-eyes" value="#4169E1">
                            <div class="color-input-label">눈</div>
                        </div>
                        <div class="color-input-item">
                            <input type="color" class="form-input" id="input-char1-skin" value="#FDBCB4">
                            <div class="color-input-label">피부</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">B 컬러차트</label>
                    <div class="color-input-group">
                        <div class="color-input-item">
                            <input type="color" class="form-input" id="input-char2-hair" value="#8B4513">
                            <div class="color-input-label">머리</div>
                        </div>
                        <div class="color-input-item">
                            <input type="color" class="form-input" id="input-char2-eyes" value="#4169E1">
                            <div class="color-input-label">눈</div>
                        </div>
                        <div class="color-input-item">
                            <input type="color" class="form-input" id="input-char2-skin" value="#FDBCB4">
                            <div class="color-input-label">피부</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- A/B 이모지 -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">A 이모지</label>
                    <input type="text" class="form-input" id="input-char1-emoji" value="🐱" maxlength="2" style="text-align: center; font-size: 18px;">
                </div>
                <div class="form-group">
                    <label class="form-label">B 이모지</label>
                    <input type="text" class="form-input" id="input-char2-emoji" value="🐰" maxlength="2" style="text-align: center; font-size: 18px;">
                </div>
            </div>

            <!-- A→B/B→A 한마디 -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">A → B 한마디</label>
                    <textarea class="form-input form-textarea" id="input-char1-speech">캐릭터 A가 캐릭터 B에게 하는 말</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">B → A 한마디</label>
                    <textarea class="form-input form-textarea" id="input-char2-speech">캐릭터 B가 캐릭터 A에게 하는 말</textarea>
                </div>
            </div>

            <!-- A/B Backstory -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">A Backstory</label>
                    <textarea class="form-input form-textarea" id="input-char1-past" placeholder="캐릭터의 과거 이야기">캐릭터의 과거 이야기가 들어갑니다.</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">B Backstory</label>
                    <textarea class="form-input form-textarea" id="input-char2-past" placeholder="캐릭터의 과거 이야기">캐릭터 B의 과거 이야기가 들어갑니다.</textarea>
                </div>
            </div>

            <!-- A/B Etc. -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">A Etc.</label>
                    <textarea class="form-input form-textarea" id="input-char1-features" placeholder="캐릭터의 특징이나 습관">캐릭터의 독특한 특징이나 습관, 버릇을 설명해주세요.</textarea>
                    <div id="char1-extra-form" style="margin-top: 15px;"></div>
                    <button type="button" onclick="app.addExtraSection('char1')" style="width: 100%; padding: 8px; background: #f0f0f0; border: 1px solid #ddd; margin-top: 10px; cursor: pointer; font-size: 12px;">+ 섹션 추가</button>
                </div>
                <div class="form-group">
                    <label class="form-label">B Etc.</label>
                    <textarea class="form-input form-textarea" id="input-char2-features" placeholder="캐릭터의 특징이나 습관">캐릭터 B의 독특한 특징이나 습관, 버릇을 설명해주세요.</textarea>
                    <div id="char2-extra-form" style="margin-top: 15px;"></div>
                    <button type="button" onclick="app.addExtraSection('char2')" style="width: 100%; padding: 8px; background: #f0f0f0; border: 1px solid #ddd; margin-top: 10px; cursor: pointer; font-size: 12px;">+ 섹션 추가</button>
                </div>
            </div>

            <!-- Timeline 편집 -->
            <div class="form-group">
                <label class="form-label">Timeline 편집</label>
                <div id="timeline-form-container"></div>
                <button type="button" class="btn-add" onclick="app.addTimelineItem()">+ Timeline 추가</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // 앱 전체 관리 객체
        const app = {
            // 데이터
            timelineData: [
                { date: '1999-06', title: '첫 만남', desc: '우연히 같은 카페에서 마주치게 되면서 시작된 인연', image: null },
                { date: '2000-03', title: '갈등', desc: '서로 다른 가치관으로 인한 첫 번째 큰 갈등이 발생', image: null },
                { date: '2020-01', title: '화해', desc: '오랜 시간이 지난 후 우연히 재회하게 되면서 새로운 관계를 시작', image: null }
            ],
            stickerData: [],
            placedStickers: [],
            selectedSticker: null,
            isDragging: false,
            isResizing: false,
            isRotating: false,
            dragOffset: { x: 0, y: 0 },
            rotateStartAngle: 0,
            extraSections: { char1: [], char2: [] }, // 추가 섹션 데이터

            // 초기화
            init() {
                this.setupEventListeners();
                this.updateTimelineDisplay();
                this.updateTimelineForm();
                this.updateColors(); // 초기 컬러 적용
            },

            // 이벤트 리스너 설정
            setupEventListeners() {
                // 입력 필드 이벤트
                const inputs = [
                    'input-pair-title', 'input-pair-subtitle', 'input-char1-name', 'input-char2-name',
                    'input-char1-gender', 'input-char1-age', 'input-char1-height', 'input-char1-job',
                    'input-char2-gender', 'input-char2-age', 'input-char2-height', 'input-char2-job',
                    'input-char1-keywords', 'input-char2-keywords', 'input-char1-past', 'input-char2-past',
                    'input-char1-features', 'input-char2-features', 'input-char1-speech', 'input-char2-speech'
                ];

                inputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', () => this.updatePreview());
                    }
                });

                // 컬러 이벤트
                document.getElementById('input-pair-color').addEventListener('change', () => this.updateColors());
                
                const colorInputs = ['char1-hair', 'char1-eyes', 'char1-skin', 'char2-hair', 'char2-eyes', 'char2-skin'];
                colorInputs.forEach(id => {
                    const element = document.getElementById(`input-${id}`);
                    if (element) {
                        element.addEventListener('change', () => this.updateCharacterColors());
                    }
                });

                // 이모지 이벤트
                document.getElementById('input-char1-emoji').addEventListener('input', () => this.updateEmojis());
                document.getElementById('input-char2-emoji').addEventListener('input', () => this.updateEmojis());

                // 이미지 업로드 이벤트
                document.getElementById('input-char1-image').addEventListener('change', (e) => this.handleImageUpload('char1', e));
                document.getElementById('input-char2-image').addEventListener('change', (e) => this.handleImageUpload('char2', e));

                // 스티커 업로드 이벤트
                document.getElementById('input-sticker-upload').addEventListener('change', (e) => this.handleStickerUpload(e));

                // 마우스 이벤트
                document.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                document.addEventListener('mouseup', () => this.handleMouseUp());
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));

                // 페어틀 카드 클릭
                document.getElementById('fairtle-card').addEventListener('click', (e) => this.handleCardClick(e));
            },

            // UI 컨트롤
            toggleEdit() {
                const panel = document.getElementById('edit-panel');
                if (panel.classList.contains('active')) {
                    panel.classList.remove('active');
                } else {
                    panel.classList.add('active');
                    this.updateInputs();
                }
            },

            closeEdit() {
                document.getElementById('edit-panel').classList.remove('active');
            },

            // 입력값을 폼에 업데이트
            updateInputs() {
                const pairs = [
                    ['pair-title', 'input-pair-title'],
                    ['pair-subtitle', 'input-pair-subtitle'],
                    ['char1-name', 'input-char1-name'],
                    ['char2-name', 'input-char2-name'],
                    ['char1-speech', 'input-char1-speech'],
                    ['char2-speech', 'input-char2-speech'],
                    ['char1-past', 'input-char1-past'],
                    ['char2-past', 'input-char2-past'],
                    ['char1-features', 'input-char1-features'],
                    ['char2-features', 'input-char2-features']
                ];

                pairs.forEach(([sourceId, targetId]) => {
                    const source = document.getElementById(sourceId);
                    const target = document.getElementById(targetId);
                    if (source && target) {
                        target.value = source.textContent;
                    }
                });

                // 기본정보 파싱
                this.parseBasicInfo('char1');
                this.parseBasicInfo('char2');

                // 키워드 파싱
                this.parseKeywords('char1');
                this.parseKeywords('char2');
            },

            parseBasicInfo(charType) {
                const basicEl = document.getElementById(`${charType}-basic`);
                if (!basicEl) return;

                const basicText = basicEl.children[0].textContent;
                const job = basicEl.children[1].textContent;
                const parts = basicText.split(' | ');

                if (parts.length >= 3) {
                    document.getElementById(`input-${charType}-gender`).value = parts[0];
                    document.getElementById(`input-${charType}-age`).value = parts[1].replace('세', '');
                    document.getElementById(`input-${charType}-height`).value = parts[2];
                }
                document.getElementById(`input-${charType}-job`).value = job;
            },

            parseKeywords(charType) {
                const keywordsEl = document.getElementById(`${charType}-keywords`);
                if (!keywordsEl) return;

                const keywords = Array.from(keywordsEl.querySelectorAll('.keyword-tag'))
                    .map(tag => tag.textContent).join(', ');
                document.getElementById(`input-${charType}-keywords`).value = keywords;
            },

            // 미리보기 업데이트
            updatePreview() {
                // 기본 텍스트 업데이트
                const updates = [
                    ['input-pair-title', 'pair-title'],
                    ['input-pair-subtitle', 'pair-subtitle'],
                    ['input-char1-name', 'char1-name'],
                    ['input-char2-name', 'char2-name'],
                    ['input-char1-speech', 'char1-speech'],
                    ['input-char2-speech', 'char2-speech'],
                    ['input-char1-past', 'char1-past'],
                    ['input-char2-past', 'char2-past'],
                    ['input-char1-features', 'char1-features'],
                    ['input-char2-features', 'char2-features']
                ];

                updates.forEach(([sourceId, targetId]) => {
                    const source = document.getElementById(sourceId);
                    const target = document.getElementById(targetId);
                    if (source && target) {
                        target.textContent = source.value;
                    }
                });

                // 기본정보 업데이트
                this.updateBasicInfo('char1');
                this.updateBasicInfo('char2');

                // 키워드 업데이트
                this.updateKeywords('char1');
                this.updateKeywords('char2');
            },

            updateBasicInfo(charType) {
                const gender = document.getElementById(`input-${charType}-gender`).value;
                const age = document.getElementById(`input-${charType}-age`).value;
                const height = document.getElementById(`input-${charType}-height`).value;
                const job = document.getElementById(`input-${charType}-job`).value;

                const basicEl = document.getElementById(`${charType}-basic`);
                if (basicEl) {
                    basicEl.innerHTML = `
                        <div>${gender} | ${age}세 | ${height.replace('cm', '')}cm</div>
                        <div>${job}</div>
                    `;
                }
            },

            updateKeywords(charType) {
                const keywordsText = document.getElementById(`input-${charType}-keywords`).value;
                const keywordsEl = document.getElementById(`${charType}-keywords`);
                if (!keywordsEl) return;

                const keywords = keywordsText.split(',').map(k => k.trim()).filter(k => k);
                keywordsEl.innerHTML = '';
                keywords.forEach(keyword => {
                    const tag = document.createElement('span');
                    tag.className = 'keyword-tag';
                    tag.textContent = keyword;
                    keywordsEl.appendChild(tag);
                });
            },

            // 컬러 업데이트
            updateColors() {
                const color = document.getElementById('input-pair-color').value;
                const root = document.documentElement;
                
                root.style.setProperty('--primary-color', color);
                root.style.setProperty('--light-color', this.hexToRgba(color, 0.1));
                root.style.setProperty('--speech-color', this.hexToRgba(color, 0.2));
                
                // 이모지 동그라미 테두리 색상 (대표컬러를 60% 투명도로 진하게)
                root.style.setProperty('--emoji-border-color', this.hexToRgba(color, 0.6));
            },

            updateCharacterColors() {
                const colors = ['char1-hair', 'char1-eyes', 'char1-skin', 'char2-hair', 'char2-eyes', 'char2-skin'];
                colors.forEach(colorId => {
                    const input = document.getElementById(`input-${colorId}`);
                    const target = document.getElementById(`${colorId}-color`);
                    if (input && target) {
                        target.style.background = input.value;
                    }
                });
            },

            updateEmojis() {
                const char1Emoji = document.getElementById('input-char1-emoji').value;
                const char2Emoji = document.getElementById('input-char2-emoji').value;
                
                document.getElementById('char1-emoji').textContent = char1Emoji;
                document.getElementById('char2-emoji').textContent = char2Emoji;
            },

            hexToRgba(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            },

            // 두 색상을 섞는 함수 (회색 베이스에 대표컬러 섞기용)
            mixColors(baseColor, mixColor, ratio) {
                const base = {
                    r: parseInt(baseColor.slice(1, 3), 16),
                    g: parseInt(baseColor.slice(3, 5), 16),
                    b: parseInt(baseColor.slice(5, 7), 16)
                };
                const mix = {
                    r: parseInt(mixColor.slice(1, 3), 16),
                    g: parseInt(mixColor.slice(3, 5), 16),
                    b: parseInt(mixColor.slice(5, 7), 16)
                };
                
                const result = {
                    r: Math.round(base.r * (1 - ratio) + mix.r * ratio),
                    g: Math.round(base.g * (1 - ratio) + mix.g * ratio),
                    b: Math.round(base.b * (1 - ratio) + mix.b * ratio)
                };
                
                return `rgb(${result.r}, ${result.g}, ${result.b})`;
            },

            // 이미지 업로드
            handleImageUpload(charType, event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const avatarEl = document.getElementById(`${charType}-avatar`);
                    if (avatarEl) {
                        avatarEl.style.backgroundImage = `url(${e.target.result})`;
                        avatarEl.classList.add('has-image');
                        // 텍스트 노드 제거
                        Array.from(avatarEl.childNodes)
                            .filter(node => node.nodeType === 3)
                            .forEach(node => node.remove());
                    }
                };
                reader.readAsDataURL(file);
            },

            // 스티커 관련
            handleStickerUpload(event) {
                const files = event.target.files;
                const container = document.getElementById('sticker-preview-container');
                
                if (this.stickerData.length === 0) {
                    container.innerHTML = '';
                }

                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const stickerId = `sticker-${Date.now()}-${Math.random()}`;
                        this.stickerData.push({
                            id: stickerId,
                            src: e.target.result,
                            name: file.name
                        });
                        this.createStickerPreview(stickerId, e.target.result);
                    };
                    reader.readAsDataURL(file);
                });
            },

            createStickerPreview(stickerId, src) {
                const container = document.getElementById('sticker-preview-container');
                const previewDiv = document.createElement('div');
                previewDiv.className = 'sticker-preview';
                previewDiv.onclick = () => this.addStickerToCard(stickerId, src);
                
                const img = document.createElement('img');
                img.src = src;
                img.alt = 'sticker';
                
                previewDiv.appendChild(img);
                container.appendChild(previewDiv);
            },

            addStickerToCard(stickerId, src) {
                const fairtle = document.getElementById('fairtle-card');
                const stickerEl = document.createElement('div');
                const placedId = `placed-${Date.now()}-${Math.random()}`;

                const tempImg = new Image();
                tempImg.onload = () => {
                    const aspectRatio = tempImg.width / tempImg.height;
                    const baseSize = 80;
                    const width = aspectRatio > 1 ? baseSize : baseSize * aspectRatio;
                    const height = aspectRatio > 1 ? baseSize / aspectRatio : baseSize;

                    stickerEl.className = 'fairtle-sticker';
                    stickerEl.id = placedId;
                    stickerEl.style.cssText = `left: 100px; top: 100px; width: ${width}px; height: ${height}px;`;
                    stickerEl.dataset.aspectRatio = aspectRatio;

                    const imgEl = document.createElement('img');
                    imgEl.src = src;
                    imgEl.draggable = false;

                    const controlsEl = document.createElement('div');
                    controlsEl.className = 'sticker-controls';
                    controlsEl.innerHTML = `
                        <button class="sticker-delete" onclick="app.removeSticker('${placedId}')" title="삭제">×</button>
                        <button class="sticker-rotate" onmousedown="app.startRotate(event, '${placedId}')" title="드래그해서 회전">↻</button>
                    `;

                    const resizeEl = document.createElement('div');
                    resizeEl.className = 'resize-handle';
                    resizeEl.onmousedown = (e) => this.startResize(e, placedId);

                    stickerEl.appendChild(imgEl);
                    stickerEl.appendChild(controlsEl);
                    stickerEl.appendChild(resizeEl);

                    stickerEl.onmousedown = (e) => this.startDrag(e, placedId);
                    stickerEl.onclick = (e) => {
                        e.stopPropagation();
                        this.selectSticker(placedId);
                    };

                    fairtle.appendChild(stickerEl);
                    
                    this.placedStickers.push({
                        id: placedId,
                        originalId: stickerId,
                        src: src,
                        x: 100, y: 100,
                        width: width, height: height,
                        aspectRatio: aspectRatio,
                        rotation: 0
                    });

                    this.selectSticker(placedId);
                };
                tempImg.src = src;
            },

            selectSticker(stickerId) {
                document.querySelectorAll('.fairtle-sticker.selected')
                    .forEach(el => el.classList.remove('selected'));
                
                const stickerEl = document.getElementById(stickerId);
                if (stickerEl) {
                    stickerEl.classList.add('selected');
                    this.selectedSticker = stickerId;
                }
            },

            removeSticker(stickerId) {
                const stickerEl = document.getElementById(stickerId);
                if (stickerEl) stickerEl.remove();
                
                this.placedStickers = this.placedStickers.filter(s => s.id !== stickerId);
                
                if (this.selectedSticker === stickerId) {
                    this.selectedSticker = null;
                }
            },

            startDrag(e, stickerId) {
                if (e.target.classList.contains('resize-handle') || 
                    e.target.classList.contains('sticker-delete') ||
                    e.target.classList.contains('sticker-rotate')) return;
                
                e.preventDefault();
                this.isDragging = true;
                this.selectedSticker = stickerId;
                this.selectSticker(stickerId);
                
                const stickerEl = document.getElementById(stickerId);
                const rect = stickerEl.getBoundingClientRect();
                
                this.dragOffset.x = e.clientX - rect.left;
                this.dragOffset.y = e.clientY - rect.top;
            },

            startResize(e, stickerId) {
                e.stopPropagation();
                e.preventDefault();
                this.isResizing = true;
                this.selectedSticker = stickerId;
                this.selectSticker(stickerId);
            },

            handleMouseMove(e) {
                if (this.isDragging && this.selectedSticker) {
                    this.dragSticker(e);
                } else if (this.isResizing && this.selectedSticker) {
                    this.resizeSticker(e);
                } else if (this.isRotating && this.selectedSticker) {
                    this.rotateSticker(e);
                }
            },

            dragSticker(e) {
                const stickerEl = document.getElementById(this.selectedSticker);
                const fairtle = document.getElementById('fairtle-card');
                const fairtleRect = fairtle.getBoundingClientRect();
                
                let newX = e.clientX - fairtleRect.left - this.dragOffset.x;
                let newY = e.clientY - fairtleRect.top - this.dragOffset.y;
                
                newX = Math.max(0, Math.min(newX, fairtle.offsetWidth - stickerEl.offsetWidth));
                newY = Math.max(0, Math.min(newY, fairtle.offsetHeight - stickerEl.offsetHeight));
                
                stickerEl.style.left = newX + 'px';
                stickerEl.style.top = newY + 'px';
                
                const sticker = this.placedStickers.find(s => s.id === this.selectedSticker);
                if (sticker) {
                    sticker.x = newX;
                    sticker.y = newY;
                }
            },

            resizeSticker(e) {
                const stickerEl = document.getElementById(this.selectedSticker);
                const fairtle = document.getElementById('fairtle-card');
                const stickerRect = stickerEl.getBoundingClientRect();
                
                const aspectRatio = parseFloat(stickerEl.dataset.aspectRatio) || 1;
                const startX = parseFloat(stickerEl.style.left);
                const startY = parseFloat(stickerEl.style.top);
                
                let newWidth = e.clientX - stickerRect.left;
                let newHeight = newWidth / aspectRatio;
                
                newWidth = Math.max(20, Math.min(newWidth, 200));
                newHeight = newWidth / aspectRatio;
                
                const maxRight = fairtle.offsetWidth - startX;
                const maxBottom = fairtle.offsetHeight - startY;
                
                if (newWidth > maxRight) {
                    newWidth = maxRight;
                    newHeight = newWidth / aspectRatio;
                }
                if (newHeight > maxBottom) {
                    newHeight = maxBottom;
                    newWidth = newHeight * aspectRatio;
                }
                
                stickerEl.style.width = newWidth + 'px';
                stickerEl.style.height = newHeight + 'px';
                
                const sticker = this.placedStickers.find(s => s.id === this.selectedSticker);
                if (sticker) {
                    sticker.width = newWidth;
                    sticker.height = newHeight;
                }
            },

            handleMouseUp() {
                this.isDragging = false;
                this.isResizing = false;
                this.isRotating = false;
            },

            handleKeyDown(e) {
                if (e.key === 'Delete' && this.selectedSticker) {
                    this.removeSticker(this.selectedSticker);
                }
            },

            handleCardClick(e) {
                if (e.target.id === 'fairtle-card' || !e.target.closest('.fairtle-sticker')) {
                    document.querySelectorAll('.fairtle-sticker.selected')
                        .forEach(el => el.classList.remove('selected'));
                    this.selectedSticker = null;
                }
            },

            // 타임라인 관련
            updateTimelineDisplay() {
                const container = document.getElementById('timeline-container');
                const existingItems = container.querySelectorAll('.timeline-item');
                existingItems.forEach(item => item.remove());

                this.timelineData.forEach((item, index) => {
                    const position = this.timelineData.length === 1 ? 50 : 
                        (index / (this.timelineData.length - 1)) * 100;
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'timeline-item';
                    itemEl.style.top = `${position}%`;
                    
                    itemEl.innerHTML = `
                        <div class="timeline-dot"></div>
                        <div class="timeline-date">${item.date}</div>
                        <div class="timeline-title-text">${item.title}</div>
                        <div class="timeline-desc">${item.desc}</div>
                        ${item.image ? `<img src="${item.image}" class="timeline-image" alt="타임라인 이미지">` : ''}
                    `;
                    
                    container.appendChild(itemEl);
                });

                // 타임라인 선을 마지막 아이템에 맞춰 조정
                const timeline = container.querySelector('.timeline-line');
                if (timeline && this.timelineData.length > 0) {
                    const lastPosition = this.timelineData.length === 1 ? 50 : 100;
                    timeline.style.height = `${lastPosition}%`;
                }
            },

            updateTimelineForm() {
                const container = document.getElementById('timeline-form-container');
                container.innerHTML = '';
                
                this.timelineData.forEach((item, index) => {
                    const formEl = document.createElement('div');
                    formEl.className = 'timeline-form-item';
                    formEl.innerHTML = `
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="form-input" placeholder="YYYY-MM" value="${item.date}" 
                                onchange="app.updateTimelineItem(${index}, 'date', this.value)">
                            <input type="text" class="form-input" placeholder="제목" value="${item.title}" 
                                onchange="app.updateTimelineItem(${index}, 'title', this.value)">
                        </div>
                        <textarea class="form-input form-textarea" placeholder="설명" 
                            onchange="app.updateTimelineItem(${index}, 'desc', this.value)">${item.desc}</textarea>
                        <input type="file" class="form-input" accept="image/*" 
                            onchange="app.updateTimelineImage(${index}, this)" style="margin-top: 10px;">
                        <button type="button" class="btn-delete" onclick="app.removeTimelineItem(${index})">삭제</button>
                    `;
                    container.appendChild(formEl);
                });
            },

            updateTimelineItem(index, field, value) {
                this.timelineData[index][field] = value;
                this.updateTimelineDisplay();
            },

            updateTimelineImage(index, input) {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.timelineData[index].image = e.target.result;
                        this.updateTimelineDisplay();
                    };
                    reader.readAsDataURL(file);
                }
            },

            addTimelineItem() {
                this.timelineData.push({
                    date: '2024-01',
                    title: '새 이벤트',
                    desc: '새로운 타임라인 이벤트 설명을 입력해주세요.',
                    image: null
                });
                this.updateTimelineDisplay();
                this.updateTimelineForm();
            },

            removeTimelineItem(index) {
                this.timelineData.splice(index, 1);
                this.updateTimelineDisplay();
                this.updateTimelineForm();
            },

            addExtraSection(charType) {
                const sectionId = `${charType}-extra-${Date.now()}`;
                const sectionData = {
                    id: sectionId,
                    title: '새 섹션',
                    content: '내용을 입력해주세요.',
                    image: null
                };
                
                this.extraSections[charType].push(sectionData);
                this.updateExtraSections(charType);
                this.updateExtraSectionForm(charType);
            },

            removeExtraSection(charType, sectionId) {
                this.extraSections[charType] = this.extraSections[charType].filter(s => s.id !== sectionId);
                this.updateExtraSections(charType);
                this.updateExtraSectionForm(charType);
            },

            updateExtraSection(charType, sectionId, field, value) {
                const section = this.extraSections[charType].find(s => s.id === sectionId);
                if (section) {
                    section[field] = value;
                    this.updateExtraSections(charType);
                }
            },

            updateExtraSectionImage(charType, sectionId, input) {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.updateExtraSection(charType, sectionId, 'image', e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            },

            updateExtraSections(charType) {
                const container = document.getElementById(`${charType}-extra-sections`);
                container.innerHTML = '';
                
                this.extraSections[charType].forEach(section => {
                    const sectionEl = document.createElement('div');
                    sectionEl.className = 'detail-section';
                    sectionEl.style.marginTop = '15px';
                    
                    // 글이 있는지 확인 (빈 문자열이나 기본 텍스트가 아닌 경우)
                    const hasContent = section.content && 
                        section.content.trim() !== '' && 
                        section.content !== '내용을 입력해주세요.';
                    
                    let innerHTML = `<div class="detail-title">${section.title}</div>`;
                    
                    if (hasContent) {
                        innerHTML += `<div class="detail-content">${section.content}</div>`;
                    }
                    
                    if (section.image) {
                        const imageStyle = hasContent ? 
                            "width: 100%; height: auto; border-radius: 5px; margin-top: 8px; border: 1px solid #ddd;" :
                            "width: 100%; height: auto; border-radius: 5px; border: 1px solid #ddd;";
                        innerHTML += `<img src="${section.image}" style="${imageStyle}" alt="섹션 이미지">`;
                    }
                    
                    sectionEl.innerHTML = innerHTML;
                    container.appendChild(sectionEl);
                });
            },

            updateExtraSectionForm(charType) {
                const formContainer = document.getElementById(`${charType}-extra-form`);
                if (!formContainer) return;
                
                formContainer.innerHTML = '';
                
                this.extraSections[charType].forEach((section, index) => {
                    const formEl = document.createElement('div');
                    formEl.className = 'form-group';
                    formEl.style.cssText = 'border: 1px solid #eee; padding: 15px; margin-bottom: 15px; background: #fafafa;';
                    formEl.innerHTML = `
                        <input type="text" class="form-input" placeholder="섹션 제목" value="${section.title}" 
                            onchange="app.updateExtraSection('${charType}', '${section.id}', 'title', this.value)" style="margin-bottom: 10px;">
                        <textarea class="form-input form-textarea" placeholder="내용" 
                            onchange="app.updateExtraSection('${charType}', '${section.id}', 'content', this.value)">${section.content}</textarea>
                        <input type="file" class="form-input" accept="image/*" 
                            onchange="app.updateExtraSectionImage('${charType}', '${section.id}', this)" style="margin-top: 10px;">
                        <button type="button" class="btn-delete" onclick="app.removeExtraSection('${charType}', '${section.id}')">삭제</button>
                    `;
                    formContainer.appendChild(formEl);
                });
            },

            startRotate(e, stickerId) {
                e.stopPropagation();
                e.preventDefault();
                this.isRotating = true;
                this.selectedSticker = stickerId;
                this.selectSticker(stickerId);
                
                const stickerEl = document.getElementById(stickerId);
                const rect = stickerEl.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                // 현재 마우스 위치에서 스티커 중심까지의 각도 계산
                const deltaX = e.clientX - centerX;
                const deltaY = e.clientY - centerY;
                const currentAngle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
                
                const sticker = this.placedStickers.find(s => s.id === stickerId);
                this.rotateStartAngle = currentAngle - (sticker ? sticker.rotation : 0);
            },

            rotateSticker(e) {
                if (!this.isRotating || !this.selectedSticker) return;
                
                const stickerEl = document.getElementById(this.selectedSticker);
                const rect = stickerEl.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                // 현재 마우스 위치에서 각도 계산
                const deltaX = e.clientX - centerX;
                const deltaY = e.clientY - centerY;
                const currentAngle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
                
                // 새로운 회전 각도 계산
                const newRotation = currentAngle - this.rotateStartAngle;
                
                // 스티커 회전 적용
                stickerEl.style.transform = `rotate(${newRotation}deg)`;
                
                // 데이터 업데이트
                const sticker = this.placedStickers.find(s => s.id === this.selectedSticker);
                if (sticker) {
                    sticker.rotation = newRotation;
                }
            },

            // 이미지 다운로드
            downloadImage() {
                const selectedElements = document.querySelectorAll('.fairtle-sticker.selected');
                const controlElements = document.querySelectorAll('.sticker-controls, .resize-handle');
                
                selectedElements.forEach(el => el.classList.remove('selected'));
                controlElements.forEach(el => el.style.display = 'none');
                
                const element = document.querySelector('.fairtle-card');
                
                html2canvas(element, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    allowTaint: true,
                    width: element.offsetWidth,
                    height: element.offsetHeight,
                    scrollX: 0,
                    scrollY: 0
                }).then(canvas => {
                    const link = document.createElement('a');
                    const pairTitle = document.getElementById('pair-title').textContent || 'fairtle';
                    link.download = `${pairTitle}_페어틀.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    controlElements.forEach(el => el.style.display = '');
                    if (this.selectedSticker) {
                        const stickerEl = document.getElementById(this.selectedSticker);
                        if (stickerEl) stickerEl.classList.add('selected');
                    }
                }).catch(error => {
                    console.error('저장 실패:', error);
                    alert('이미지 저장에 실패했습니다. 다시 시도해주세요.');
                    
                    controlElements.forEach(el => el.style.display = '');
                    if (this.selectedSticker) {
                        const stickerEl = document.getElementById(this.selectedSticker);
                        if (stickerEl) stickerEl.classList.add('selected');
                    }
                });
            }
        };

        // 페이지 로드 시 앱 초기화
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
